<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JM Financeiro Ultra</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #f8f9fa;
            --surface-solid: #ffffff;
            --gold-start: #d4af37; --gold-end: #b48811;
            --gold-gradient: linear-gradient(135deg, var(--gold-start), var(--gold-end));
            --text-primary: #1a1a1a; --text-secondary: #6c757d;
            
            --success: #27ae60; --success-bg: #eafaf1;
            --danger: #c0392b; --danger-bg: #fadbd8;
            --info: #2980b9; --info-bg: #ebf5fb;
            --fiado: #8e44ad; --fiado-bg: #f5eef8;
            --produto: #00cec9; --produto-bg: #e0fbfb;
            
            --radius-xl: 24px; --radius-lg: 16px;
            --shadow-soft: 0 8px 30px rgba(0,0,0,0.04);
            --nav-height: 80px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-body); 
            background-image: radial-gradient(circle at 10% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 20%);
            color: var(--text-primary); margin: 0; padding-bottom: calc(var(--nav-height) + 40px); overflow-x: hidden;
        }

        /* --- LOADER ELITE --- */
        #pro-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999; background: #111; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.6s, visibility 0.6s; }
        #pro-loader.finish-loading { opacity: 0; visibility: hidden; pointer-events: none; }
        .loader-content { text-align: center; animation: float 3s ease-in-out infinite; }
        .loader-logo { font-size: 4rem; margin-bottom: 10px; display: block; text-shadow: 0 0 20px rgba(212, 175, 55, 0.6); }
        .loader-text { color: #d4af37; font-size: 1.5rem; font-weight: 800; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 30px; }
        .progress-bar-container { width: 200px; height: 4px; background: #333; border-radius: 4px; overflow: hidden; margin-top: 20px; }
        .progress-bar { width: 0%; height: 100%; background: var(--gold-gradient); box-shadow: 0 0 10px rgba(212, 175, 55, 0.5); transition: width 2.5s ease-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- UI GERAL --- */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 11000; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: white; padding: 16px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; margin-bottom: 10px; animation: slideDown 0.4s; border-left: 5px solid #333; pointer-events: auto; }
        .toast.success { border-left-color: var(--success); } .toast.error { border-left-color: var(--danger); }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        header { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .header-logo h1 { margin: 0; font-size: 1.2rem; background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        .btn-ajuda { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #eee; background: white; color: var(--gold-end); font-weight: bold; cursor: pointer; }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .tab-content { display: none; animation: fadeIn 0.4s; } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD --- */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .card { background: var(--surface-solid); padding: 15px; border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow-soft); border: 1px solid #f0f0f0; display: flex; flex-direction: column; justify-content: center; min-height: 100px; transition: transform 0.3s, box-shadow 0.3s; }
        
        .card.full { grid-column: span 2; padding: 20px; }
        .card.lucro { background: linear-gradient(145deg, #fff, #fffdf5); border: 1px solid rgba(212, 175, 55, 0.2); }
        .card.fiado { background: var(--fiado-bg); border: 1px solid rgba(142, 68, 173, 0.2); grid-column: span 2; }
        .card.fiado .valor { color: var(--fiado); }
        .card.entrada-box { background: var(--success-bg); border: 1px solid #d4efdf; }
        .card.entrada-box h3, .card.entrada-box .valor { color: var(--success); }
        .card.saida-box { background: var(--danger-bg); border: 1px solid #fadbd8; }
        .card.saida-box h3, .card.saida-box .valor { color: var(--danger); }

        .card h3 { margin: 0 0 5px; font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .card .valor { font-size: 1.3rem; font-weight: 800; color: var(--text-primary); }
        .card.lucro .valor { color: #b48811; font-size: 2rem; }

        .segmented-control { display: flex; background: #e0e0e0; padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .segment-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #666; font-weight: 600; cursor: pointer; border-radius: 10px; transition: 0.3s; }
        .segment-btn.active { background: white; color: var(--text-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* --- FORM --- */
        .form-container { background: var(--surface-solid); padding: 20px; border-radius: var(--radius-xl); box-shadow: var(--shadow-soft); margin-bottom: 25px; transition: transform 0.3s; }
        input, select { width: 100%; padding: 15px; background: #f4f6f8; border: 2px solid transparent; border-radius: 12px; margin-bottom: 12px; font-family: inherit; font-size: 1rem; outline: none; }
        input:focus, select:focus { background: white; border-color: var(--gold-start); }
        label { font-size: 0.75rem; color: #888; font-weight: 700; margin-left: 5px; text-transform: uppercase; }

        .btn-main { width: 100%; padding: 18px; border: none; border-radius: 14px; font-weight: 800; text-transform: uppercase; color: white; background: var(--gold-gradient); box-shadow: 0 8px 20px -5px rgba(180, 136, 17, 0.4); cursor: pointer; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); }
        .btn-dark { background: #2d3436; box-shadow: 0 8px 20px -5px rgba(0,0,0,0.3); display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        
        .check-container { display: flex; align-items: center; gap: 10px; background: var(--fiado-bg); padding: 12px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; border: 1px solid #d2b4de; }
        .custom-check { width: 20px; height: 20px; border: 2px solid var(--fiado); border-radius: 5px; display: flex; align-items: center; justify-content: center; background: white; }
        input[type="checkbox"]:checked + .custom-check { background: var(--fiado); }

        /* --- LISTAS --- */
        .item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 16px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .item-icon { width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1.1rem; }
        .item.vencendo-hoje { border: 2px solid var(--danger); background: #fff5f5; animation: pulseRed 2s infinite; }
        .alert-badge { background: var(--danger); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; margin-left: 8px; display: inline-block; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        
        /* Estilo para conta paga */
        .item.conta-paga { border: 1px solid #2ecc71; background: #f0fff4; opacity: 0.8; }
        .badge-pago { background: #2ecc71; color: white; padding: 3px 6px; border-radius: 5px; font-size: 0.65rem; font-weight: bold; margin-left: 5px; }

        /* --- NAV --- */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); height: 70px; border-radius: 35px; display: flex; justify-content: space-evenly; align-items: center; box-shadow: 0 15px 40px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { border: none; background: none; color: #ccc; display: flex; flex-direction: column; align-items: center; width: 60px; transition: 0.3s; }
        .nav-item.active { color: var(--gold-end); transform: translateY(-5px); }
        .nav-icon { font-size: 1.4rem; } .nav-label { font-size: 0.6rem; font-weight: 700; margin-top: 2px; }

        /* --- MODAIS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); z-index: 9000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 25px; width: 85%; max-width: 350px; text-align: center; animation: zoomIn 0.3s; max-height: 80vh; overflow-y: auto; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- TUTORIAL FIXO EM BAIXO --- */
        #tutorial-overlay { align-items: flex-end; justify-content: center; padding-bottom: 0; }
        .ajudante-container-fixa {
            background: white; width: 100%; max-width: 500px; 
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            padding: 20px; position: relative; text-align: center;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
            animation: slideUpTuto 0.4s ease-out;
        }
        #img-pedro { 
            width: 220px; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            z-index: 10005; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); pointer-events: none;
        }
        .balao-menu { max-height: 50vh; overflow-y: auto; text-align: left; padding-top: 10px; }
        
        .tutorial-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .btn-faq {
            background: #f8f9fa; border: 1px solid #eee; padding: 12px 15px; border-radius: 12px;
            text-align: left; font-weight: 600; color: #333; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
        }
        .btn-faq:active { background: var(--gold-gradient); color: white; border-color: transparent; }
        .btn-faq::after { content: 'üëâ'; font-size: 0.9rem; }

        .destaque-tutorial {
            position: relative; z-index: 10001; 
            box-shadow: 0 0 0 4px #fff, 0 0 0 8px var(--gold-start), 0 0 100px rgba(0,0,0,0.8) !important;
            transform: scale(1.02); transition: 0.3s; background: white !important;
        }
        @keyframes slideUpTuto { from { transform: translateY(100%); } to { transform: translateY(0); } }

    </style>
</head>
<body>

    <div id="toast-container"></div>
    
    <div id="pro-loader">
        <div class="loader-content">
            <span class="loader-logo">‚ú®</span>
            <div class="loader-text">JM Financeiro</div>
            <div class="progress-bar-container"><div class="progress-bar" id="loader-bar"></div></div>
            <small style="color:#555; margin-top:10px; display:block;">Carregando sistema...</small>
        </div>
    </div>

    <div id="modal-calendario" class="modal-overlay">
        <div class="modal-box">
            <h3>üìÖ Iniciar Caixa</h3>
            <p style="color:#777; font-size:0.9rem;">Selecione a data de trabalho:</p>
            <input type="date" id="data-verificacao" style="text-align:center;">
            <button class="btn-main" onclick="confirmarDataInicial()">Confirmar</button>
        </div>
    </div>

    <div id="modal-detalhes" class="modal-overlay">
        <div class="modal-box" style="text-align:left;">
            <h3 id="titulo-detalhes" style="color:var(--gold-end); border-bottom:1px solid #eee; padding-bottom:10px;">Detalhes</h3>
            <div id="conteudo-detalhes" style="margin-top:15px;"></div>
            <button onclick="document.getElementById('modal-detalhes').style.display='none'" style="width:100%; padding:15px; margin-top:20px; background:#333; color:white; border:none; border-radius:12px;">Fechar</button>
        </div>
    </div>

    <div id="modal-conta" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:var(--info);">Nova Conta Fixa</h3>
            <div style="text-align:left;">
                <label>Nome</label><input type="text" id="nova-conta-nome">
                <label>Valor (R$)</label><input type="number" id="nova-conta-valor">
                <label>Vencimento</label><input type="date" id="nova-conta-data">
            </div>
            <button class="btn-main" style="background:var(--info);" onclick="salvarContaModal()">Salvar</button>
            <button onclick="fecharModalConta()" style="margin-top:15px; border:none; background:none; color:#999;">Cancelar</button>
        </div>
    </div>

    <div id="tutorial-overlay" class="modal-overlay" style="background:rgba(0,0,0,0.8); display:none; align-items: flex-end;">
        <div class="ajudante-container-fixa">
            <img id="img-pedro" src="pedro1.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712109.png'">
            
            <div class="balao-menu">
                <div id="tutorial-menu">
                    <h3 style="margin:0 0 5px 0; color:var(--text-primary);">Fala Chefe! üíà</h3>
                    <p style="color:#777; font-size:0.9rem; margin-bottom:15px;">Toque na d√∫vida para eu te mostrar:</p>
                    <div class="tutorial-list" id="faq-list"></div>
                    <button onclick="fecharTutorial()" style="width:100%; padding:12px; margin-top:15px; background:#eee; border:none; border-radius:12px; color:#555;">Fechar Ajuda</button>
                </div>

                <div id="tutorial-resposta" style="display:none;">
                    <h4 id="faq-titulo" style="margin:0 0 10px 0; color:var(--gold-end);">...</h4>
                    <p id="faq-texto" style="font-size:0.95rem; color:#444; line-height:1.6;">...</p>
                    <button class="btn-main" onclick="voltarMenu()" style="padding:12px; margin-top:20px;">Entendi, voltar</button>
                </div>
            </div>
        </div>
    </div>

    <header>
        <div class="header-logo"><h1>JM FINANCEIRO</h1></div>
        <button class="btn-ajuda" onclick="abrirTutorial()">?</button>
    </header>

    <div class="container">
        
        <div id="tab-salao" class="tab-content active">
            
            <button class="btn-main btn-dark" id="btn-concluir-dia" onclick="concluirDia()">
                <span>‚úÖ</span> FECHAR O DIA (Check-in)
            </button>
            
            <div class="segmented-control" id="area-visao">
                <button class="segment-btn active" id="seg-hoje" onclick="mudarVisao('hoje')">Ver Hoje</button>
                <button class="segment-btn" id="seg-mes" onclick="mudarVisao('mes')">Ver M√™s</button>
            </div>

            <div class="dashboard" id="area-dashboard">
                <div class="card full lucro">
                    <h3 id="titulo-lucro">Lucro L√≠quido (Hoje)</h3>
                    <div class="valor" id="saldoSalao">R$ 0,00</div>
                </div>
                
                <div class="card fiado" id="card-fiado">
                    <h3>‚ö†Ô∏è A Receber (Fiado)</h3>
                    <div class="valor" id="totalPendente">R$ 0,00</div>
                </div>
                
                <div class="card entrada-box">
                    <h3>Entradas (Servi√ßos)</h3>
                    <div class="valor" id="totalServicos">R$ 0,00</div>
                </div>

                <div class="card saida-box" id="card-saida">
                    <h3>Sa√≠das (Despesas)</h3>
                    <div class="valor" id="saidasSalao">R$ 0,00</div>
                </div>
                
                <div class="card full" style="border: 1px solid var(--produto); background:var(--produto-bg);">
                    <h3 style="color:var(--produto);">Venda Produtos</h3>
                    <div class="valor" style="color:var(--produto);" id="totalProdutos">R$ 0,00</div>
                </div>
            </div>

            <div class="form-container" id="area-lancamento">
                <h4 style="margin:0 0 15px 0;">Novo Lan√ßamento</h4>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Data</label><input type="date" id="dataSalao"></div>
                    <div><label>Valor</label><input type="number" id="valorSalao" inputmode="decimal" placeholder="0.00"></div>
                </div>
                
                <label>Tipo</label>
                <select id="tipoSalao" onchange="verificarTipo()">
                    <option value="entrada_servico">‚úÇÔ∏è Servi√ßo (Corte/Barba)</option>
                    <option value="entrada_produto">üß¥ Venda de Produto</option>
                    <option value="entrada_total">üí∞ Fechamento Total</option>
                    <option value="saida">üí∏ Despesa/Sa√≠da</option>
                </select>

                <div id="container-desc">
                    <label>Descri√ß√£o</label>
                    <input type="text" id="descSalao" placeholder="Ex: Corte Degrade">
                </div>
                
                <div id="grupoPendente" class="check-container" onclick="toggleCheck()">
                    <input type="checkbox" id="checkPendente" style="display:none;">
                    <div class="custom-check"></div>
                    <label style="margin:0; cursor:pointer; color:var(--fiado); font-weight:bold;">Marcar como FIADO</label>
                </div>
                
                <button class="btn-main" onclick="adicionar('salao')">Lan√ßar</button>
            </div>

            <div id="listaSalao"></div>
            <button id="btn-fechar-mes" onclick="fecharMes()" style="width:100%; padding:15px; border:2px solid var(--danger); background:none; color:var(--danger); font-weight:bold; border-radius:14px; margin-top:30px;">üîí FECHAR E ARQUIVAR M√äS</button>
        </div>

        <div id="tab-casa" class="tab-content">
            <div class="card full" style="background:#ebf5fb; border-color:#d6eaf8; margin-bottom:20px;">
                <h3 style="color:#2980b9;">Gasto Pessoal (M√™s)</h3>
                <div class="valor" style="color:#2980b9;" id="saldoCasa">R$ 0,00</div>
            </div>

            <div class="form-container" id="area-fixas">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4>Contas Fixas</h4>
                    <button onclick="abrirModalConta()" style="background:var(--info); color:white; border:none; width:30px; height:30px; border-radius:8px;">+</button>
                </div>
                <div id="listaFixas" style="margin-top:15px;"></div>
            </div>

            <div class="form-container">
                <h4>Gasto Avulso</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="date" id="dataCasa">
                    <input type="number" id="valorCasa" placeholder="Valor">
                </div>
                <input type="text" id="descCasa" placeholder="Descri√ß√£o">
                <button class="btn-main" style="background:linear-gradient(135deg, #3498db, #2980b9);" onclick="adicionar('casa')">Salvar Gasto</button>
            </div>
            <div id="listaCasa"></div>
        </div>

        <div id="tab-historico" class="tab-content">
            <h3 style="text-align:center;">Relat√≥rios Fechados</h3>
            <div id="lista-meses-fechados"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="mudarAba('salao')" id="nav-salao"><span class="nav-icon">‚úÇÔ∏è</span><span class="nav-label">Sal√£o</span></button>
        <button class="nav-item" onclick="mudarAba('casa')" id="nav-casa"><span class="nav-icon">üè†</span><span class="nav-label">Casa</span></button>
        <button class="nav-item" onclick="mudarAba('historico')" id="nav-historico"><span class="nav-icon">üìÇ</span><span class="nav-label">Hist√≥rico</span></button>
    </nav>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registrado!', reg))
                    .catch(err => console.log('Erro SW:', err));
            });
        }
    </script>

    <script>
        // --- DADOS ---
        let transacoes = JSON.parse(localStorage.getItem('jm_financas_v27')) || [];
        let contasFixas = JSON.parse(localStorage.getItem('jm_fixas_v5')) || [];
        let historicoFechado = JSON.parse(localStorage.getItem('jm_historico_v17')) || [];
        let visaoAtual = 'hoje';

        // --- SISTEMA DE D√öVIDAS DO PEDRO ---
        const duvidas = [
            { t: "Como lan√ßo um corte?", r: "√â f√°cil! Na aba Sal√£o, coloque o valor, escolha 'Servi√ßo' e clique em LAN√áAR. Eu destaquei a √°rea pra voc√™.", el: "area-lancamento" },
            { t: "Como funciona o Fiado?", r: "Se o cliente n√£o pagou, marque a caixinha 'Marcar como FIADO'. O valor vai pro cart√£o roxo 'A Receber' e n√£o soma no seu lucro hoje.", el: "card-fiado" },
            { t: "Onde coloco despesas?", r: "Se gastou com o sal√£o (l√¢mina, caf√©), lance como 'Despesa/Sa√≠da' aqui no Sal√£o. Se foi gasto pessoal, v√° para a aba CASA.", el: "card-saida" },
            { t: "Pra que serve Fechar o Dia?", r: "Todo dia, quando terminar, clique no bot√£o preto 'FECHAR O DIA'. Eu calculo seu lucro e j√° mudo a data pra amanh√£.", el: "btn-concluir-dia" },
            { t: "Fechamento Total", r: "Se voc√™ prefere lan√ßar o valor total do dia de uma vez s√≥, use a op√ß√£o 'Fechamento Total'. O valor vai somar nas suas Entradas de Servi√ßo.", el: "area-lancamento" },
            { t: "Como vejo o m√™s todo?", r: "Use esses bot√µes aqui em cima. 'Ver Hoje' mostra s√≥ o dia atual. 'Ver M√™s' soma tudo do dia 1 at√© agora.", el: "area-visao" },
            { t: "Como fecho o M√™s?", r: "No √∫ltimo dia, clique no bot√£o l√° embaixo 'FECHAR E ARQUIVAR'. Eu salvo tudo no Hist√≥rico e limpo a tela pro m√™s novo.", el: "btn-fechar-mes" },
            { t: "Contas Fixas (√Ågua/Luz)", r: "Na aba CASA, cadastre suas contas. Se voc√™ pagar, ela fica verde. Se vencer hoje e n√£o pagar, ela fica vermelha!", el: "area-fixas", aba: "casa" },
            { t: "Vendi um produto, e agora?", r: "Lance como 'Venda de Produto'. Eu separo o dinheiro dos produtos num card azul, pra n√£o misturar com sua m√£o de obra.", el: "area-dashboard" },
            { t: "Como vejo meses antigos?", r: "Tudo que voc√™ fecha vai pra aba HIST√ìRICO. L√° tem um bot√£o 'Ver Detalhes' pra ver quanto ganhou dia por dia.", el: "nav-historico", aba: "historico" }
        ];

        function abrirTutorial() {
            document.getElementById('tutorial-overlay').style.display = 'flex';
            document.getElementById('tutorial-menu').style.display = 'block';
            document.getElementById('tutorial-resposta').style.display = 'none';
            const lista = document.getElementById('faq-list');
            lista.innerHTML = '';
            duvidas.forEach((d, index) => {
                lista.innerHTML += `<div class="btn-faq" onclick="verResposta(${index})">${d.t}</div>`;
            });
        }

        function verResposta(index) {
            const d = duvidas[index];
            document.getElementById('tutorial-menu').style.display = 'none';
            document.getElementById('tutorial-resposta').style.display = 'block';
            document.getElementById('faq-titulo').innerText = d.t;
            document.getElementById('faq-texto').innerText = d.r;
            document.getElementById('img-pedro').src = "pedro2.png"; 

            if(d.aba) mudarAba(d.aba);
            
            setTimeout(() => {
                if(d.el) {
                    const el = document.getElementById(d.el);
                    if(el) {
                        el.classList.add('destaque-tutorial');
                        el.scrollIntoView({behavior: "smooth", block: "center"});
                    }
                }
            }, 300);
        }

        function voltarMenu() {
            document.getElementById('tutorial-menu').style.display = 'block';
            document.getElementById('tutorial-resposta').style.display = 'none';
            document.getElementById('img-pedro').src = "pedro1.png"; 
            document.querySelectorAll('.destaque-tutorial').forEach(el => el.classList.remove('destaque-tutorial'));
        }

        function fecharTutorial() {
            document.getElementById('tutorial-overlay').style.display = 'none';
            voltarMenu();
        }

        // --- CORE ---
        window.onload = function() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('data-verificacao').value = hoje;
            document.getElementById('dataSalao').value = hoje;
            document.getElementById('dataCasa').value = hoje;
            document.getElementById('nova-conta-data').value = hoje;

            setTimeout(() => { document.getElementById('loader-bar').style.width = '100%'; }, 100);
            setTimeout(() => {
                document.getElementById('pro-loader').classList.add('finish-loading');
                setTimeout(() => document.getElementById('modal-calendario').style.display = 'flex', 600);
            }, 2500);
            
            renderizarFixas();
        };

        function confirmarDataInicial() {
            const data = document.getElementById('data-verificacao').value;
            if(!data) return;
            document.getElementById('dataSalao').value = data;
            document.getElementById('dataCasa').value = data;
            
            document.getElementById('modal-calendario').style.display = 'none';
            atualizarTela();
            renderizarFixas(); // Re-checa vencimentos com a data nova
        }

        function mudarAba(aba) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + aba).classList.add('active');
            document.getElementById('nav-' + aba).classList.add('active');
            window.scrollTo({top:0, behavior:'smooth'});
            if(aba==='historico') renderizarHistorico();
        }

        function mudarVisao(tipo) {
            visaoAtual = tipo;
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            if(tipo === 'hoje') {
                document.getElementById('seg-hoje').classList.add('active');
                document.getElementById('titulo-lucro').innerText = 'Lucro L√≠quido (Hoje)';
            } else {
                document.getElementById('seg-mes').classList.add('active');
                document.getElementById('titulo-lucro').innerText = 'Lucro L√≠quido (M√™s)';
            }
            atualizarTela();
        }

        function verificarTipo() {
            const tipo = document.getElementById('tipoSalao').value;
            const containerDesc = document.getElementById('container-desc');
            const grupoPendente = document.getElementById('grupoPendente');
            const descInput = document.getElementById('descSalao');

            if (tipo === 'entrada_total') {
                containerDesc.style.display = 'none';
                grupoPendente.style.display = 'none'; 
                const dia = document.getElementById('dataSalao').value.split('-').reverse().join('/');
                descInput.value = `Fechamento do Dia ${dia}`;
            } else if (tipo === 'saida') {
                containerDesc.style.display = 'block';
                descInput.value = '';
                grupoPendente.style.display = 'none';
                document.getElementById('checkPendente').checked = false;
            } else {
                containerDesc.style.display = 'block';
                descInput.value = '';
                grupoPendente.style.display = 'flex';
            }
        }

        function toggleCheck() {
            const chk = document.getElementById('checkPendente');
            chk.checked = !chk.checked;
        }

        function adicionar(origem) {
            let desc = document.getElementById('descSalao').value;
            let valor = parseFloat(document.getElementById('valorSalao').value);
            let tipo = document.getElementById('tipoSalao').value;
            let data = document.getElementById('dataSalao').value;
            let isPendente = false;

            if (origem === 'casa') {
                desc = document.getElementById('descCasa').value;
                valor = parseFloat(document.getElementById('valorCasa').value);
                tipo = 'saida';
                data = document.getElementById('dataCasa').value;
            } else {
                if (tipo === 'entrada_total' && !desc) {
                    const dia = data.split('-').reverse().join('/');
                    desc = `Fechamento do Dia ${dia}`;
                }
                if (document.getElementById('checkPendente').checked && tipo !== 'saida' && tipo !== 'entrada_total') isPendente = true;
            }

            if (!desc || isNaN(valor) || !data) { showToast('Preencha os campos!', 'error'); return; }

            transacoes.unshift({
                id: Date.now(), desc, valor, categoria: origem, tipo,
                status: isPendente ? 'pendente' : 'pago',
                dataDisplay: data.split('-').reverse().join('/'), dataISO: data
            });

            localStorage.setItem('jm_financas_v27', JSON.stringify(transacoes));
            atualizarTela();
            showToast('Lan√ßamento Salvo!', 'success');

            // Se pagou conta fixa, re-renderiza para atualizar status
            if(origem === 'casa') renderizarFixas();

            if(origem === 'salao') {
                document.getElementById('valorSalao').value = '';
                if(tipo !== 'entrada_total') document.getElementById('descSalao').value = '';
                document.getElementById('checkPendente').checked = false;
            } else {
                document.getElementById('valorCasa').value = '';
                document.getElementById('descCasa').value = '';
            }
        }

        function receber(id, valor) {
            if(confirm(`üí∞ Confirmar recebimento de R$ ${valor.toFixed(2)}?`)) {
                const idx = transacoes.findIndex(t => t.id === id);
                if(idx > -1) {
                    transacoes[idx].status = 'pago';
                    localStorage.setItem('jm_financas_v27', JSON.stringify(transacoes));
                    atualizarTela();
                    showToast('Pagamento Confirmado!', 'success');
                }
            }
        }

        function renderizarFixas() {
            const div = document.getElementById('listaFixas'); div.innerHTML = '';
            const dataSelecionada = document.getElementById('dataCasa').value;
            const mesAtual = dataSelecionada.substring(0, 7); // "YYYY-MM"
            const diaHoje = parseInt(dataSelecionada.split('-')[2]);

            contasFixas.forEach(c => {
                const diaConta = parseInt(c.dia);
                // Verifica se j√° foi paga neste m√™s
                const jaPago = transacoes.some(t => 
                    t.desc === c.desc && 
                    t.dataISO.startsWith(mesAtual) && 
                    t.tipo === 'saida'
                );

                const venceHoje = (!jaPago && diaConta === diaHoje);
                
                let classeExtra = '';
                let statusMsg = `Dia ${c.dia} ‚Ä¢ R$ ${c.valor.toFixed(2)}`;
                let btnHtml = '';

                if (jaPago) {
                    classeExtra = 'conta-paga';
                    statusMsg += ' <span class="badge-pago">PAGO ‚úÖ</span>';
                    btnHtml = `<button disabled style="border:none; background:none; color:#2ecc71; font-weight:bold; margin-right:5px;">Ok</button>`;
                } else {
                    if (venceHoje) {
                        classeExtra = 'vencendo-hoje';
                        statusMsg += '<br>‚ö†Ô∏è PAGAR AGORA!';
                    }
                    btnHtml = `<button onclick="lancarFixa(${c.id})" style="border:none; background:${venceHoje ? '#c0392b' : '#d6eaf8'}; color:${venceHoje ? 'white' : '#2980b9'}; padding:8px 12px; border-radius:8px; font-weight:bold; cursor:pointer; margin-right:5px;">Pagar</button>`;
                }
                
                div.innerHTML += `
                <div class="item ${classeExtra}">
                    <div style="flex:1;">
                        <strong>${c.desc} ${venceHoje ? '<span class="alert-badge">HOJE!</span>' : ''}</strong>
                        <small style="color:${venceHoje ? 'red' : '#777'}; font-weight:${venceHoje ? 'bold' : 'normal'}">
                            ${statusMsg}
                        </small>
                    </div>
                    <div>
                        ${btnHtml}
                        <button onclick="delFixa(${c.id})" style="border:none; background:none; color:#999;">x</button>
                    </div>
                </div>`;
            });
        }

        function atualizarTela() {
            const listaSalao = document.getElementById('listaSalao');
            const listaCasa = document.getElementById('listaCasa');
            listaSalao.innerHTML = ''; listaCasa.innerHTML = '';
            
            let sServicos=0, sProdutos=0, sTotal=0, sSaida=0, sCasa=0, sPendente=0;
            const hojeISO = document.getElementById('dataSalao').value;

            transacoes.forEach(t => {
                let mostrar = true;
                if (t.categoria === 'salao' && visaoAtual === 'hoje' && t.dataISO !== hojeISO) mostrar = false;

                if (t.categoria === 'salao') {
                    if (t.status === 'pendente') {
                        sPendente += t.valor;
                    } else if (mostrar || visaoAtual === 'mes') {
                        let deveSomar = (visaoAtual === 'hoje') ? (t.dataISO === hojeISO) : true;
                        if(deveSomar) {
                            if(t.tipo === 'entrada_servico') sServicos += t.valor;
                            else if(t.tipo === 'entrada_produto') sProdutos += t.valor;
                            else if(t.tipo === 'entrada_total') sTotal += t.valor; 
                            else sSaida += t.valor;
                        }
                    }
                } else {
                    sCasa += t.valor;
                }

                if ((t.categoria === 'salao' && !mostrar)) return;

                const el = document.createElement('div');
                el.className = 'item';
                
                let icone = '‚úÇÔ∏è'; let colorClass = 'text-green'; let sinal = '+';
                let bgIcon = '#eafaf1';

                if(t.tipo === 'entrada_produto') { icone='üß¥'; colorClass='text-prod'; bgIcon='#e0fbfb'; }
                if(t.tipo === 'entrada_total') { icone='üí∞'; colorClass='text-primary'; bgIcon='#ebf5fb'; }
                if(t.tipo === 'saida') { icone='üí∏'; colorClass='text-red'; sinal='-'; bgIcon='#fdedeb'; }
                
                let actionBtn = `<button onclick="remover(${t.id})" style="background:none; border:none; color:#ccc; font-size:1.2rem;">&times;</button>`;
                
                if(t.status === 'pendente') {
                    icone='‚ö†Ô∏è'; colorClass='text-primary'; sinal=''; bgIcon='var(--fiado-bg)';
                    actionBtn = `<button onclick="receber(${t.id}, ${t.valor})" style="background:var(--success); color:white; border:none; padding:5px 10px; border-radius:6px; font-weight:bold; margin-right:10px;">RECEBER</button>` + actionBtn;
                    el.style.borderLeft = "4px solid var(--fiado)";
                }

                el.innerHTML = `
                    <div style="display:flex; align-items:center; flex:1;">
                        <div class="item-icon" style="background:${bgIcon}">${icone}</div>
                        <div><strong>${t.desc}</strong><small>${t.dataDisplay}</small></div>
                    </div>
                    <div style="text-align:right;">
                        <div class="${colorClass}" style="font-weight:bold; margin-right:10px;">${sinal} R$ ${t.valor.toFixed(2)}</div>
                    </div>
                    ${actionBtn}
                `;

                if(t.categoria==='salao') listaSalao.appendChild(el);
                else listaCasa.appendChild(el);
            });

            // LOGICA: Total do Dia soma junto com Servi√ßos
            let servicosExibicao = sServicos + sTotal;

            document.getElementById('totalServicos').innerText = `R$ ${servicosExibicao.toFixed(2)}`;
            document.getElementById('totalProdutos').innerText = `R$ ${sProdutos.toFixed(2)}`;
            document.getElementById('saidasSalao').innerText = `R$ ${sSaida.toFixed(2)}`;
            document.getElementById('totalPendente').innerText = `R$ ${sPendente.toFixed(2)}`;
            
            let lucroReal = (sServicos + sProdutos + sTotal) - sSaida;
            document.getElementById('saldoSalao').innerText = `R$ ${lucroReal.toFixed(2)}`;
            document.getElementById('saldoCasa').innerText = `R$ ${sCasa.toFixed(2)}`;
        }

        function remover(id) {
            if(confirm('Tem certeza que deseja apagar?')) {
                transacoes = transacoes.filter(t => t.id !== id);
                localStorage.setItem('jm_financas_v27', JSON.stringify(transacoes));
                atualizarTela();
                renderizarFixas();
            }
        }

        function concluirDia() {
            const hoje = document.getElementById('dataSalao').value;
            const doDia = transacoes.filter(t => t.categoria === 'salao' && t.dataISO === hoje && t.status !== 'pendente');
            let lucro = 0; doDia.forEach(t => t.tipo.includes('entrada') ? lucro+=t.valor : lucro-=t.valor);

            if(confirm(`‚úÖ FECHAR O DIA?\n\nLucro: R$ ${lucro.toFixed(2)}\n\nIr para amanh√£?`)) {
                const d = new Date(hoje); d.setDate(d.getDate() + 1);
                const amanha = d.toISOString().split('T')[0];
                document.getElementById('dataSalao').value = amanha;
                mudarVisao('hoje');
                showToast('Dia Conclu√≠do!', 'success');
            }
        }

        function fecharMes() {
            if(!confirm("‚ö†Ô∏è ATEN√á√ÉO: Deseja fechar o m√™s e arquivar?")) return;
            const nome = prompt("Nome do M√™s (Ex: Mar√ßo 2026):");
            if(!nome) return;

            let totais = { serv:0, prod:0, total:0, saida:0, casa:0 };
            let diasMap = {}; 

            transacoes.forEach(t => {
                if(t.categoria==='salao' && t.status!=='pendente') {
                    if(t.tipo==='entrada_servico') totais.serv+=t.valor;
                    else if(t.tipo==='entrada_produto') totais.prod+=t.valor;
                    else if(t.tipo==='entrada_total') totais.total+=t.valor;
                    else totais.saida+=t.valor;

                    if(!diasMap[t.dataDisplay]) diasMap[t.dataDisplay] = 0;
                    if(t.tipo.includes('entrada')) diasMap[t.dataDisplay] += t.valor; else diasMap[t.dataDisplay] -= t.valor;

                } else if (t.categoria==='casa') totais.casa+=t.valor;
            });

            let lucroLiquido = (totais.serv + totais.prod + totais.total) - totais.saida;
            let listaDias = Object.keys(diasMap).map(data => { return {data: data, valor: diasMap[data]} });

            historicoFechado.unshift({ 
                id: Date.now(), 
                nome, 
                data: new Date().toLocaleDateString(), 
                totais: {...totais, lucro: lucroLiquido},
                detalhes: listaDias 
            });

            localStorage.setItem('jm_historico_v17', JSON.stringify(historicoFechado));
            transacoes = transacoes.filter(t => t.status === 'pendente');
            localStorage.setItem('jm_financas_v27', JSON.stringify(transacoes));
            
            atualizarTela();
            renderizarHistorico();
            showToast('M√™s Arquivado com Sucesso!', 'success');
        }

        function renderizarHistorico() {
            const div = document.getElementById('lista-meses-fechados'); div.innerHTML='';
            historicoFechado.forEach(h => {
                div.innerHTML += `
                <div class="item" style="display:block;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <div>
                            <strong>${h.nome}</strong><br>
                            <small>${h.data}</small>
                        </div>
                        <div class="text-green" style="font-weight:bold; font-size:1.2rem;">
                            R$ ${h.totais.lucro.toFixed(2)}
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button onclick='verDetalhes(${JSON.stringify(h)})' style="flex:1; background:#333; color:white; border:none; padding:10px; border-radius:10px;">üìÑ Ver Detalhes</button>
                        <button onclick="if(confirm('Apagar?')) { historicoFechado=historicoFechado.filter(x=>x.id!==${h.id}); localStorage.setItem('jm_historico_v17', JSON.stringify(historicoFechado)); renderizarHistorico(); }" style="background:#fadbd8; color:#c0392b; border:none; padding:10px 15px; border-radius:10px;">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
        }

        function verDetalhes(hist) {
            const container = document.getElementById('conteudo-detalhes');
            document.getElementById('titulo-detalhes').innerText = "Resumo: " + hist.nome;
            container.innerHTML = '';

            if(!hist.detalhes || hist.detalhes.length === 0) {
                container.innerHTML = "<p>Sem detalhes di√°rios salvos.</p>";
            } else {
                hist.detalhes.forEach(d => {
                    container.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #ddd;">
                        <span>üìÖ ${d.data}</span>
                        <strong style="color:${d.valor>=0?'var(--success)':'var(--danger)'}">R$ ${d.valor.toFixed(2)}</strong>
                    </div>`;
                });
                 let servTotal = hist.totais.serv + hist.totais.total;
                 container.innerHTML += `
                    <div style="margin-top:20px; background:#f9f9f9; padding:10px; border-radius:10px;">
                        <div style="display:flex; justify-content:space-between;"><small>Servi√ßos (+Total):</small> <span>R$ ${servTotal.toFixed(2)}</span></div>
                        <div style="display:flex; justify-content:space-between;"><small>Produtos:</small> <span>R$ ${hist.totais.prod.toFixed(2)}</span></div>
                        <div style="display:flex; justify-content:space-between;"><small>Sa√≠das:</small> <span style="color:red">- R$ ${hist.totais.saida.toFixed(2)}</span></div>
                        <hr style="border:0; border-top:1px solid #ccc; margin:5px 0;">
                        <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>LUCRO:</span> <span style="color:green">R$ ${hist.totais.lucro.toFixed(2)}</span></div>
                    </div>`;
            }
            document.getElementById('modal-detalhes').style.display = 'flex';
        }

        function showToast(msg, tipo) {
            const t = document.createElement('div'); t.className=`toast ${tipo}`; t.innerHTML=`<span>${tipo==='success'?'‚úÖ':'‚ö†Ô∏è'}</span><span>${msg}</span>`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 3000);
            if(navigator.vibrate) navigator.vibrate(50);
        }
        function abrirModalConta() { document.getElementById('modal-conta').style.display='flex'; }
        function fecharModalConta() { document.getElementById('modal-conta').style.display='none'; }
        function salvarContaModal() {
            const n=document.getElementById('nova-conta-nome').value; const v=document.getElementById('nova-conta-valor').value; const d=document.getElementById('nova-conta-data').value;
            if(!n||!v||!d) return showToast('Preencha tudo', 'error');
            contasFixas.push({id:Date.now(), desc:n, valor:parseFloat(v), dia: d.split('-')[2]});
            localStorage.setItem('jm_fixas_v5', JSON.stringify(contasFixas));
            renderizarFixas(); fecharModalConta();
        }
        function delFixa(id) { if(confirm('Excluir conta?')){ contasFixas=contasFixas.filter(c=>c.id!==id); localStorage.setItem('jm_fixas_v5', JSON.stringify(contasFixas)); renderizarFixas(); }}
        function lancarFixa(id) {
            const c=contasFixas.find(x=>x.id===id);
            if(confirm(`Pagar ${c.desc}?`)){
                transacoes.unshift({ id:Date.now(), desc:c.desc, valor:c.valor, categoria:'casa', tipo:'saida', status:'pago', dataDisplay:document.getElementById('dataCasa').value.split('-').reverse().join('/'), dataISO:document.getElementById('dataCasa').value });
                localStorage.setItem('jm_financas_v27', JSON.stringify(transacoes)); 
                atualizarTela(); 
                renderizarFixas(); 
                showToast('Paga!', 'success');
            }
        }
    </script>
</body>
</html>